<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE FRAUD FACTORY - Geographic Scale & The Conspirators</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* OVERLAY A - Map markers and connections */
        #overlay-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            transition: opacity 0.5s ease;
        }

        #overlay-map.hidden {
            opacity: 0;
        }

        #map-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* OVERLAY B - Face network */
        #overlay-network {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            background: rgba(0, 0, 0, 0.45);
        }

        #overlay-network.visible {
            opacity: 1;
            pointer-events: all;
        }

        #network-svg {
            width: 100%;
            height: 100%;
        }

        /* UI Elements */
        .overlay-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            pointer-events: none;
        }

        .overlay-title h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            text-shadow: 0 0 30px rgba(220, 53, 69, 0.8), 0 0 60px rgba(220, 53, 69, 0.4);
            margin-bottom: 8px;
        }

        .overlay-title .subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .legend h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.6);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #fff;
        }

        .legend-marker {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .stats-panel {
            position: absolute;
            top: 100px;
            right: 30px;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats-panel h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .stat-row {
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #dc3545;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        /* Toggle Button */
        .toggle-container {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-btn {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }

        .toggle-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.02);
        }

        .toggle-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #dc3545;
        }

        .toggle-btn.secondary {
            background: rgba(100, 100, 100, 0.8);
        }

        .toggle-btn.secondary:hover {
            background: rgba(150, 150, 150, 0.9);
        }

        /* Popups */
        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px !important;
            color: #fff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .mapboxgl-popup-close-button {
            color: #fff;
            font-size: 20px;
        }

        .mapboxgl-popup-tip {
            border-top-color: rgba(0, 0, 0, 0.95) !important;
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .popup-role {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .popup-detail {
            font-size: 0.9rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.8);
        }

        .role-created, .role-fraud-factory { color: #dc3545; }
        .role-enforced { color: #fd7e14; }
        .role-coverup { color: #ffc107; }
        .role-institutional { color: #adb5bd; }

        /* Map Markers */
        .map-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            border: 3px solid rgba(255,255,255,0.3);
            transition: transform 0.2s, opacity 0.5s;
        }

        .map-marker:hover {
            transform: scale(1.3);
        }

        .map-marker.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .map-marker-fraud-factory {
            width: 60px;
            height: 60px;
            background: #dc3545;
            animation: pulse-red 2s infinite;
            font-size: 28px;
            border: 4px solid rgba(255,255,255,0.5);
        }

        .map-marker-created { background: #dc3545; box-shadow: 0 0 20px #dc3545; }
        .map-marker-enforced { background: #fd7e14; box-shadow: 0 0 20px #fd7e14; }
        .map-marker-coverup { background: #ffc107; color: #000; box-shadow: 0 0 20px #ffc107; }
        .map-marker-institutional { background: #6c757d; box-shadow: 0 0 20px #6c757d; }
        .map-marker-victim { background: #fff; border: 4px solid #dc3545; color: #dc3545; }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px #dc3545, 0 0 40px rgba(220, 53, 69, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 50px #dc3545, 0 0 100px rgba(220, 53, 69, 0.8); transform: scale(1.05); }
        }

        /* Map connection lines - BOLD corruption web */
        .map-connection-line {
            stroke: rgba(220, 53, 69, 0.9);
            stroke-width: 4;
            fill: none;
            transition: opacity 0.5s;
        }

        .map-connection-glow {
            stroke: rgba(220, 53, 69, 0.4);
            stroke-width: 20;
            fill: none;
            filter: blur(6px);
            transition: opacity 0.5s;
        }

        .map-connection-line.hidden, .map-connection-glow.hidden {
            opacity: 0;
        }

        /* Network tooltip */
        .network-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 1000;
            color: #fff;
        }

        .network-tooltip h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        /* Location Card Panel */
        .location-card-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 500;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
            max-width: 90vw;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8), 0 0 100px rgba(220, 53, 69, 0.2);
        }

        .location-card-panel.visible {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .location-card-panel img {
            display: block;
            max-width: 85vw;
            max-height: 75vh;
            object-fit: contain;
            border-radius: 12px;
        }

        .location-card-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px 25px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            z-index: 10;
        }

        .location-card-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .location-card-header .tagline {
            font-size: 0.85rem;
            color: #fd7e14;
            margin-top: 5px;
            font-style: italic;
        }

        .location-card-close {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .location-card-close:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .location-card-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .location-card-backdrop.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Face Hub - orbital faces around courthouse */
        .face-hub-container {
            position: absolute;
            pointer-events: none;
            z-index: 80;
        }

        .face-hub-marker {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            overflow: hidden;
            border: 3px solid;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .face-hub-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 100;
        }

        .face-hub-marker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-hub-marker .face-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(0,0,0,0.9);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .face-hub-marker:hover .face-label {
            opacity: 1;
        }

        .face-hub-marker.created { border-color: #dc3545; box-shadow: 0 0 15px rgba(220, 53, 69, 0.6); }
        .face-hub-marker.enforced { border-color: #fd7e14; box-shadow: 0 0 15px rgba(253, 126, 20, 0.6); }
        .face-hub-marker.coverup { border-color: #ffc107; box-shadow: 0 0 15px rgba(255, 193, 7, 0.6); }
        .face-hub-marker.institutional { border-color: #6c757d; box-shadow: 0 0 15px rgba(108, 117, 125, 0.6); }

        .face-hub-marker.active {
            animation: face-pulse 1s ease-out;
        }

        @keyframes face-pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Animated corruption line */
        .animated-line {
            stroke: rgba(220, 53, 69, 0.9);
            stroke-width: 4;
            fill: none;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        .animated-line.animating {
            animation: draw-line 1.5s ease-out forwards;
        }

        .animated-line-glow {
            stroke: rgba(220, 53, 69, 0.3);
            stroke-width: 15;
            fill: none;
            filter: blur(5px);
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        .animated-line-glow.animating {
            animation: draw-line 1.5s ease-out forwards;
        }

        @keyframes draw-line {
            to { stroke-dashoffset: 0; }
        }

        .network-tooltip .role {
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .network-tooltip .detail {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
        }

        /* Network elements */
        .network-link { stroke-opacity: 0.5; fill: none; }
        .network-link-glow { stroke-opacity: 0.2; fill: none; filter: blur(3px); }
        .node-group { cursor: pointer; }
        .node-ring { fill: none; stroke-width: 4; }
        .node-ring-glow { fill: none; stroke-width: 12; opacity: 0.3; filter: blur(4px); }
        .node-label {
            font-size: 11px;
            font-weight: 600;
            fill: #fff;
            text-anchor: middle;
            text-shadow: 0 0 8px rgba(0,0,0,0.9), 0 0 15px rgba(0,0,0,0.9);
            pointer-events: none;
        }

        .fraud-factory-node {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Base Map -->
    <div id="map"></div>

    <!-- Overlay A: Map markers and connections -->
    <div id="overlay-map">
        <svg id="map-connections"></svg>
        <svg id="animated-connections" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></svg>
    </div>

    <!-- Face Hub - orbiting faces around courthouse -->
    <div id="face-hub" class="face-hub-container"></div>

    <!-- Overlay B: Face network -->
    <div id="overlay-network">
        <svg id="network-svg"></svg>
    </div>

    <!-- UI Elements -->
    <div class="overlay-title">
        <h1>The Fraud Factory</h1>
        <div class="subtitle" id="view-subtitle">Geographic Scale of Corruption Across Los Angeles County</div>
    </div>

    <div class="legend">
        <h3>Role in Scheme</h3>
        <div class="legend-item">
            <div class="legend-marker" style="background: #dc3545; box-shadow: 0 0 10px #dc3545;"></div>
            <span>Created the Fraud</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #fd7e14; box-shadow: 0 0 10px #fd7e14;"></div>
            <span>Enforced / Prosecuted</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #ffc107; box-shadow: 0 0 10px #ffc107;"></div>
            <span>Covered Up</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker" style="background: #6c757d; box-shadow: 0 0 10px #6c757d;"></div>
            <span>Institutional</span>
        </div>
    </div>

    <div class="stats-panel">
        <h3>The Scale</h3>
        <div class="stat-row">
            <div class="stat-value">4,752</div>
            <div class="stat-label">Square Miles</div>
        </div>
        <div class="stat-row">
            <div class="stat-value">10M+</div>
            <div class="stat-label">People Affected</div>
        </div>
        <div class="stat-row">
            <div class="stat-value">1 in 441K</div>
            <div class="stat-label">Odds of Coincidence</div>
        </div>
        <div class="stat-row">
            <div class="stat-value">0</div>
            <div class="stat-label">Who Stopped It</div>
        </div>
    </div>

    <div class="toggle-container">
        <button class="toggle-btn active" id="btn-locations" onclick="showLocations()">
            Show Locations
        </button>
        <button class="toggle-btn" id="btn-faces" onclick="showFaces()">
            Show Faces
        </button>
        <button class="toggle-btn secondary" id="btn-fly" onclick="flyToFraudFactory()">
            Back to Hub
        </button>
    </div>

    <div class="network-tooltip" id="network-tooltip"></div>

    <!-- Location Card Panel -->
    <div class="location-card-backdrop" id="card-backdrop" onclick="closeLocationCard()"></div>
    <div class="location-card-panel" id="location-card">
        <button class="location-card-close" onclick="closeLocationCard()">&times;</button>
        <div class="location-card-header">
            <h2 id="card-title">Airport Courthouse</h2>
            <div class="tagline" id="card-tagline">Where Prosecution Became Persecution</div>
        </div>
        <img id="card-image" src="" alt="Location detail">
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFybG93c2E1Njc4IiwiYSI6ImNtazM1OWU1MjBtd2MzZW9ndXFyaDRic2wifQ.hE48oMee_n-JjqqWjYDI1Q';
        const imgBase = './images/';

        // Colors
        const colors = {
            'fraud-factory': '#dc3545',
            created: '#dc3545',
            enforced: '#fd7e14',
            coverup: '#ffc107',
            institutional: '#6c757d',
            victim: '#ffffff'
        };

        // ==================== MAP LOCATIONS ====================
        const mapLocations = [
            { id: 'fraud-factory', name: 'Stanley Mosk Courthouse', coords: [-118.2439, 34.0544], role: 'fraud-factory', roleLabel: 'THE FRAUD FACTORY', detail: 'The largest trial court in the United States. Inside it, a fraud factory produces fake restraining orders on demand.', markerClass: 'map-marker-fraud-factory', hasCard: true, cardImage: './images/stanley-mosk-card.jpg', cardTitle: 'Stanley Mosk Courthouse', cardTagline: 'The Fraud Factory' },
            { id: 'majd', name: 'Majd & Associates', coords: [-118.4021, 34.0736], role: 'created', roleLabel: 'Attorney Filing Fraud', detail: 'Farbood Majd files applications that bypass judicial review.', markerClass: 'map-marker-created' },
            { id: 'costa-rica', name: 'Costa Rica Consulate', coords: [-118.2706, 34.0392], role: 'institutional', roleLabel: 'Diplomatic Connection', detail: 'Ana Rojas claims diplomatic status through Costa Rica.', markerClass: 'map-marker-institutional' },
            { id: 'west-la-pd', name: 'West LA Police Station', coords: [-118.4505, 34.0349], role: 'enforced', roleLabel: 'Enforced Despite No CLETS', detail: 'Officers verified NO orders in CLETS on 4 occasions. Enforced anyway.', markerClass: 'map-marker-enforced', hasCard: true, cardImage: './images/west-la-pd-card.jpg', cardTitle: 'West Los Angeles Police Station', cardTagline: 'Four Officers. Four CLETS Searches. Zero Orders Found.' },
            { id: 'dcfs', name: 'DCFS', coords: [-118.2833, 34.0617], role: 'institutional', roleLabel: 'Closed Abuse Investigation', detail: 'Closed the investigation into Arlo\'s brain damage.', markerClass: 'map-marker-institutional' },
            { id: 'da-office', name: 'District Attorney', coords: [-118.2467, 34.0539], role: 'enforced', roleLabel: 'Prosecuted Void Orders', detail: 'Filed criminal charges for violating orders never in CLETS.', markerClass: 'map-marker-enforced' },
            { id: 'airport-courthouse', name: 'Airport Courthouse', coords: [-118.3796, 33.9299], role: 'coverup', roleLabel: 'Prosecution HQ', detail: 'Where Lee Caldwell and Suneeta Israni suppressed evidence and manufactured charges.', markerClass: 'map-marker-coverup', hasCard: true, cardImage: './images/airport-courthouse-card.jpg', cardTitle: 'Airport Courthouse', cardTagline: 'Where Prosecution Became Persecution' },
            { id: 'wegman-levin', name: 'Wegman & Levin', coords: [-118.4486, 34.1612], role: 'coverup', roleLabel: 'Defense Failure', detail: 'Four attorneys. None verified CLETS.', markerClass: 'map-marker-coverup' },
            { id: 'kerry-residence', name: 'Kerry Family Home', coords: [-118.4150, 34.0520], role: 'victim', roleLabel: 'Scene of Abduction', detail: 'July 31, 2023: Brain-damaged infant taken from protective father.', markerClass: 'map-marker-victim' }
        ];

        const mapConnections = [
            { from: 'fraud-factory', to: 'majd' },
            { from: 'fraud-factory', to: 'da-office' },
            { from: 'fraud-factory', to: 'west-la-pd' },
            { from: 'fraud-factory', to: 'dcfs' },
            { from: 'fraud-factory', to: 'airport-courthouse' },
            { from: 'majd', to: 'kerry-residence' },
            { from: 'west-la-pd', to: 'kerry-residence' },
            { from: 'wegman-levin', to: 'fraud-factory' },
        ];

        // ==================== NETWORK NODES ====================
        const networkNodes = [
            { id: "fraud-factory", label: "THE FRAUD\nFACTORY", group: "fraud-factory", role: "Stanley Mosk Courthouse", detail: "The largest trial court in the United States. Inside it operates a fraud factory.", size: 50, isCenter: true },
            { id: "majd", label: "Farbood Majd", group: "created", role: "Attorney - Bar #209498", detail: "Files fraudulent applications. Appears on bodycam executing fake orders.", image: imgBase + "farbood-majd.jpg", size: 42 },
            { id: "mikaelian", label: "Gevork Mikaelian", group: "created", role: "Court Clerk", detail: "Processed ALL THREE fraudulent applications. Applied unauthorized stamp. The inside man.", image: imgBase + "gevork-mikaelian.jpg", size: 42 },
            { id: "ana", label: "Ana Rojas", group: "created", role: "Petitioner / Abuser", detail: "Caused brain damage to infant Arlo. Used fraud to escape investigation.", image: imgBase + "ana-rojas.png", size: 38 },
            { id: "diaz", label: "Officer Diaz", group: "enforced", role: "LAPD", detail: "12-minute CLETS search found NOTHING. Orders enforced anyway.", image: imgBase + "officer-diaz.png", size: 32 },
            { id: "wasserman", label: "David Wasserman", group: "coverup", role: "Family Court Judge", detail: "False explanation about stamps. Knew he lacked jurisdiction.", image: imgBase + "david-wasserman.jpg", size: 38 },
            { id: "gonzalez", label: "Liliana Gonzalez", group: "coverup", role: "Criminal Judge", detail: "'CLETS is irrelevant' - contradicting California law.", image: imgBase + "liliana-gonzalez.jpg", size: 38 },
            { id: "cheney", label: "Chris Cheney", group: "coverup", role: "Defense Attorney", detail: "Promoted the fake order scheme to his own client as legitimate.", image: imgBase + "chris-cheney.png", size: 32 },
            { id: "levin", label: "Michael Levin", group: "coverup", role: "Wegman & Levin", detail: "Part of defense team that failed to verify CLETS.", image: imgBase + "michael-levin.jpg", size: 32 },
            { id: "israni", label: "Suneeta Israni", group: "institutional", role: "Official", detail: "Institutional complicity in processing fraudulent orders.", image: imgBase + "suneeta-israni.jpg", size: 32 },
            { id: "esteban", label: "Esteban Rojas", group: "institutional", role: "Ana's Father", detail: "Involved in conspiracy to obtain fraudulent orders.", image: imgBase + "esteban-rojas.png", size: 32 }
        ];

        const networkLinks = [
            { source: "majd", target: "fraud-factory", type: "created" },
            { source: "mikaelian", target: "fraud-factory", type: "created" },
            { source: "ana", target: "fraud-factory", type: "created" },
            { source: "majd", target: "mikaelian", type: "created" },
            { source: "majd", target: "ana", type: "created" },
            { source: "ana", target: "esteban", type: "institutional" },
            { source: "diaz", target: "fraud-factory", type: "enforced" },
            { source: "wasserman", target: "fraud-factory", type: "coverup" },
            { source: "gonzalez", target: "fraud-factory", type: "coverup" },
            { source: "cheney", target: "fraud-factory", type: "coverup" },
            { source: "levin", target: "fraud-factory", type: "coverup" },
            { source: "israni", target: "fraud-factory", type: "institutional" },
        ];

        // ==================== STATE ====================
        let currentView = 'locations'; // 'locations' or 'faces'
        let mapMarkers = {};
        let faceHubMarkers = [];

        // ==================== FACE HUB DATA ====================
        // Faces that orbit the courthouse - each links to a destination
        const faceHubData = [
            { id: 'majd', name: 'Farbood Majd', image: imgBase + 'farbood-majd.jpg', group: 'created', role: 'Attorney', detail: 'Files fraudulent applications', destLocation: 'majd', angle: 0 },
            { id: 'mikaelian', name: 'Gevork Mikaelian', image: imgBase + 'gevork-mikaelian.jpg', group: 'created', role: 'Court Clerk', detail: 'The inside man - processed all 3 fake orders', destLocation: 'fraud-factory', angle: 36 },
            { id: 'ana', name: 'Ana Rojas', image: imgBase + 'ana-rojas.png', group: 'created', role: 'Abuser', detail: 'Caused infant brain damage', destLocation: 'kerry-residence', angle: 72 },
            { id: 'diaz', name: 'Officer Diaz', image: imgBase + 'officer-diaz.png', group: 'enforced', role: 'LAPD', detail: '12min CLETS search found nothing', destLocation: 'west-la-pd', angle: 108 },
            { id: 'wasserman', name: 'David Wasserman', image: imgBase + 'david-wasserman.jpg', group: 'coverup', role: 'Family Judge', detail: 'False stamp explanation', destLocation: 'fraud-factory', angle: 144 },
            { id: 'gonzalez', name: 'Liliana Gonzalez', image: imgBase + 'liliana-gonzalez.jpg', group: 'coverup', role: 'Criminal Judge', detail: 'CLETS is irrelevant', destLocation: 'airport-courthouse', angle: 180 },
            { id: 'israni', name: 'Suneeta Israni', image: imgBase + 'suneeta-israni.jpg', group: 'institutional', role: 'Prosecutor', detail: 'Evidence tampering', destLocation: 'airport-courthouse', angle: 216 },
            { id: 'cheney', name: 'Chris Cheney', image: imgBase + 'chris-cheney.png', group: 'coverup', role: 'Defense Attorney', detail: 'Failed to verify CLETS', destLocation: 'wegman-levin', angle: 252 },
            { id: 'levin', name: 'Michael Levin', image: imgBase + 'michael-levin.jpg', group: 'coverup', role: 'Wegman & Levin', detail: 'Defense team failure', destLocation: 'wegman-levin', angle: 288 },
            { id: 'esteban', name: 'Esteban Rojas', image: imgBase + 'esteban-rojas.png', group: 'institutional', role: 'Ana\'s Father', detail: 'Conspiracy participant', destLocation: 'costa-rica', angle: 324 }
        ];

        const COURTHOUSE_COORDS = [-118.2439, 34.0544]; // Stanley Mosk
        const HUB_RADIUS = 120; // pixels from courthouse center

        // ==================== INITIALIZE MAP ====================
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-118.35, 34.02],
            zoom: 9.5,
            pitch: 60,
            bearing: -15,
            antialias: true
        });

        map.on('load', () => {
            // Add terrain
            map.addSource('mapbox-dem', {
                type: 'raster-dem',
                url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                tileSize: 512,
                maxzoom: 14
            });
            map.setTerrain({ source: 'mapbox-dem', exaggeration: 2.0 });

            // Add sky
            map.addLayer({
                id: 'sky',
                type: 'sky',
                paint: {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });

            // Add 3D buildings - darker/translucent on satellite
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(layer => layer.type === 'symbol' && layer.layout['text-field'])?.id;
            map.addLayer({
                id: 'add-3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                filter: ['==', 'extrude', 'true'],
                type: 'fill-extrusion',
                minzoom: 13,
                paint: {
                    'fill-extrusion-color': '#1a1a2e',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7
                }
            }, labelLayerId);

            // Hide most labels - keep major place names only
            layers.forEach(layer => {
                if (layer.type === 'symbol') {
                    // Keep only major settlement labels for context
                    if (layer.id.includes('settlement-major') || layer.id.includes('country') || layer.id.includes('state')) {
                        // Keep these visible
                    } else {
                        map.setLayoutProperty(layer.id, 'visibility', 'none');
                    }
                }
            });

            // Add map markers
            mapLocations.forEach(loc => {
                const el = document.createElement('div');
                el.className = `map-marker ${loc.markerClass}`;
                if (loc.role === 'fraud-factory') el.innerHTML = '!';

                const marker = new mapboxgl.Marker(el).setLngLat(loc.coords).addTo(map);
                mapMarkers[loc.id] = { marker, element: el };

                const popup = new mapboxgl.Popup({ offset: 25, closeButton: true, closeOnClick: false })
                    .setHTML(`<div class="popup-title">${loc.name}</div><div class="popup-role role-${loc.role}">${loc.roleLabel}</div><div class="popup-detail">${loc.detail}</div>`);

                el.addEventListener('click', () => {
                    document.querySelectorAll('.mapboxgl-popup').forEach(p => p.remove());

                    // If location has a card, show the card panel
                    if (loc.hasCard) {
                        showLocationCard(loc);
                    } else {
                        popup.setLngLat(loc.coords).addTo(map);
                    }
                    map.flyTo({ center: loc.coords, zoom: 15, pitch: 65, duration: 2500 });
                });
            });

            updateMapConnections();

            // Initial fly-in - center on courthouse
            setTimeout(() => {
                map.flyTo({ center: COURTHOUSE_COORDS, zoom: 11.5, pitch: 55, bearing: 0, duration: 4000 });
            }, 1000);

            // Initialize face hub after map settles
            setTimeout(() => {
                initFaceHub();
            }, 2000);
        });

        map.on('move', () => { updateMapConnections(); updateFaceHubPositions(); });
        map.on('zoom', () => { updateMapConnections(); updateFaceHubPositions(); });
        map.on('pitch', () => { updateMapConnections(); updateFaceHubPositions(); });
        map.on('rotate', () => { updateMapConnections(); updateFaceHubPositions(); });

        function updateMapConnections() {
            const svg = document.getElementById('map-connections');
            svg.innerHTML = '';

            mapConnections.forEach(conn => {
                const fromLoc = mapLocations.find(l => l.id === conn.from);
                const toLoc = mapLocations.find(l => l.id === conn.to);
                if (!fromLoc || !toLoc) return;

                const fromPoint = map.project(fromLoc.coords);
                const toPoint = map.project(toLoc.coords);
                const midX = (fromPoint.x + toPoint.x) / 2;
                const midY = (fromPoint.y + toPoint.y) / 2;
                const dx = toPoint.x - fromPoint.x;
                const dy = toPoint.y - fromPoint.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 1) return;

                const curveOffset = dist * 0.25;
                const perpX = -dy / dist * curveOffset;
                const perpY = dx / dist * curveOffset;
                const pathData = `M ${fromPoint.x} ${fromPoint.y} Q ${midX + perpX} ${midY + perpY} ${toPoint.x} ${toPoint.y}`;

                const hiddenClass = currentView === 'faces' ? ' hidden' : '';

                const glowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                glowPath.setAttribute('d', pathData);
                glowPath.setAttribute('class', 'map-connection-glow' + hiddenClass);
                svg.appendChild(glowPath);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'map-connection-line' + hiddenClass);
                svg.appendChild(path);
            });
        }

        // ==================== FACE HUB FUNCTIONS ====================
        function initFaceHub() {
            const container = document.getElementById('face-hub');
            container.innerHTML = '';
            faceHubMarkers = [];

            faceHubData.forEach(face => {
                const marker = document.createElement('div');
                marker.className = `face-hub-marker ${face.group}`;
                marker.innerHTML = `
                    <img src="${face.image}" alt="${face.name}" onerror="this.style.display='none'">
                    <div class="face-label">${face.name}</div>
                `;
                marker.dataset.faceId = face.id;

                marker.addEventListener('click', () => onFaceHubClick(face));

                container.appendChild(marker);
                faceHubMarkers.push({ element: marker, data: face });
            });

            updateFaceHubPositions();
        }

        function updateFaceHubPositions() {
            const courthousePoint = map.project(COURTHOUSE_COORDS);

            faceHubMarkers.forEach(({ element, data }) => {
                const angleRad = (data.angle - 90) * Math.PI / 180;
                const x = courthousePoint.x + Math.cos(angleRad) * HUB_RADIUS;
                const y = courthousePoint.y + Math.sin(angleRad) * HUB_RADIUS;

                element.style.left = x + 'px';
                element.style.top = y + 'px';
            });
        }

        function onFaceHubClick(face) {
            // Find destination location
            const destLoc = mapLocations.find(l => l.id === face.destLocation);
            if (!destLoc) return;

            // Pulse the clicked face
            const marker = faceHubMarkers.find(m => m.data.id === face.id);
            if (marker) {
                marker.element.classList.add('active');
                setTimeout(() => marker.element.classList.remove('active'), 1000);
            }

            // Animate the connection line
            animateConnectionLine(COURTHOUSE_COORDS, destLoc.coords, () => {
                // After animation, fly to destination and show card
                map.flyTo({ center: destLoc.coords, zoom: 14.5, pitch: 65, duration: 2500 });

                setTimeout(() => {
                    if (destLoc.hasCard) {
                        showLocationCard(destLoc);
                    } else {
                        // Show popup
                        new mapboxgl.Popup({ offset: 25, closeButton: true })
                            .setLngLat(destLoc.coords)
                            .setHTML(`
                                <div class="popup-title">${destLoc.name}</div>
                                <div class="popup-role role-${destLoc.role}">${destLoc.roleLabel}</div>
                                <div class="popup-detail">${destLoc.detail}</div>
                                <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2);font-size:0.8rem;color:rgba(255,255,255,0.6);">
                                    <strong>${face.name}</strong>: ${face.detail}
                                </div>
                            `)
                            .addTo(map);
                    }
                }, 2000);
            });
        }

        function animateConnectionLine(fromCoords, toCoords, callback) {
            const svg = document.getElementById('animated-connections');
            svg.innerHTML = '';

            const fromPoint = map.project(fromCoords);
            const toPoint = map.project(toCoords);

            // Calculate curved path
            const midX = (fromPoint.x + toPoint.x) / 2;
            const midY = (fromPoint.y + toPoint.y) / 2;
            const dx = toPoint.x - fromPoint.x;
            const dy = toPoint.y - fromPoint.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const curveOffset = dist * 0.2;
            const perpX = -dy / dist * curveOffset;
            const perpY = dx / dist * curveOffset;

            const pathData = `M ${fromPoint.x} ${fromPoint.y} Q ${midX + perpX} ${midY + perpY} ${toPoint.x} ${toPoint.y}`;

            // Create glow path
            const glowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            glowPath.setAttribute('d', pathData);
            glowPath.setAttribute('class', 'animated-line-glow');
            svg.appendChild(glowPath);

            // Create main path
            const mainPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mainPath.setAttribute('d', pathData);
            mainPath.setAttribute('class', 'animated-line');
            svg.appendChild(mainPath);

            // Get path length and set it
            const pathLength = mainPath.getTotalLength();
            mainPath.style.strokeDasharray = pathLength;
            mainPath.style.strokeDashoffset = pathLength;
            glowPath.style.strokeDasharray = pathLength;
            glowPath.style.strokeDashoffset = pathLength;

            // Trigger animation
            requestAnimationFrame(() => {
                mainPath.classList.add('animating');
                glowPath.classList.add('animating');
            });

            // Clear after animation and callback
            setTimeout(() => {
                if (callback) callback();
            }, 1500);

            // Keep the line visible for a bit then fade
            setTimeout(() => {
                svg.innerHTML = '';
            }, 5000);
        }

        // ==================== INITIALIZE NETWORK ====================
        const networkSvg = d3.select("#network-svg");
        const networkTooltip = d3.select("#network-tooltip");
        let networkSimulation;

        function initNetwork() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            networkSvg.attr("viewBox", [0, 0, width, height]);

            // Create clip paths
            const defs = networkSvg.append("defs");
            networkNodes.forEach(node => {
                if (node.image) {
                    defs.append("clipPath")
                        .attr("id", `clip-${node.id}`)
                        .append("circle")
                        .attr("r", node.size - 4)
                        .attr("cx", 0)
                        .attr("cy", 0);
                }
            });

            // Simulation
            networkSimulation = d3.forceSimulation(networkNodes)
                .force("link", d3.forceLink(networkLinks).id(d => d.id).distance(160))
                .force("charge", d3.forceManyBody().strength(-1000))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => d.size + 25));

            // Link glows
            const linkGlow = networkSvg.append("g").selectAll("line").data(networkLinks).join("line")
                .attr("class", "network-link-glow")
                .attr("stroke", d => colors[d.type] || colors.created)
                .attr("stroke-width", 10);

            // Links
            const link = networkSvg.append("g").selectAll("line").data(networkLinks).join("line")
                .attr("class", "network-link")
                .attr("stroke", d => colors[d.type] || colors.created)
                .attr("stroke-width", 2);

            // Nodes
            const nodeGroup = networkSvg.append("g").selectAll("g").data(networkNodes).join("g")
                .attr("class", "node-group")
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

            nodeGroup.append("circle").attr("class", "node-ring-glow").attr("r", d => d.size + 2).attr("stroke", d => colors[d.group]);
            nodeGroup.append("circle").attr("class", "node-ring").attr("r", d => d.size).attr("stroke", d => colors[d.group]);

            nodeGroup.each(function(d) {
                const g = d3.select(this);
                if (d.image) {
                    g.append("image")
                        .attr("xlink:href", d.image)
                        .attr("x", -(d.size - 4))
                        .attr("y", -(d.size - 4))
                        .attr("width", (d.size - 4) * 2)
                        .attr("height", (d.size - 4) * 2)
                        .attr("clip-path", `url(#clip-${d.id})`)
                        .attr("preserveAspectRatio", "xMidYMid slice");
                } else {
                    g.append("circle").attr("class", "fraud-factory-node").attr("r", d.size - 4).attr("fill", "rgba(220, 53, 69, 0.3)");
                    g.append("text").attr("text-anchor", "middle").attr("dominant-baseline", "middle").attr("fill", "#fff").attr("font-size", "28px").attr("font-weight", "bold").text("!");
                }
            });

            nodeGroup.append("text").attr("class", "node-label").attr("y", d => d.size + 16)
                .selectAll("tspan").data(d => d.label.split("\n")).join("tspan")
                .attr("x", 0).attr("dy", (d, i) => i ? "1.2em" : 0).text(d => d);

            nodeGroup.on("mouseover", function(event, d) {
                networkTooltip.style("opacity", 1).html(`<h4>${d.label.replace("\n", " ")}</h4><div class="role role-${d.group}">${d.role}</div><div class="detail">${d.detail}</div>`);
                d3.select(this).select(".node-ring").transition().duration(200).attr("stroke-width", 6);
            })
            .on("mousemove", function(event) {
                networkTooltip.style("left", (event.pageX + 20) + "px").style("top", (event.pageY - 20) + "px");
            })
            .on("mouseout", function() {
                networkTooltip.style("opacity", 0);
                d3.select(this).select(".node-ring").transition().duration(200).attr("stroke-width", 4);
            });

            networkSimulation.on("tick", () => {
                linkGlow.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                nodeGroup.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) { if (!event.active) networkSimulation.alphaTarget(0.3).restart(); event.subject.fx = event.subject.x; event.subject.fy = event.subject.y; }
            function dragged(event) { event.subject.fx = event.x; event.subject.fy = event.y; }
            function dragended(event) { if (!event.active) networkSimulation.alphaTarget(0); event.subject.fx = null; event.subject.fy = null; }
        }

        initNetwork();

        // ==================== VIEW TOGGLE ====================
        function showLocations() {
            currentView = 'locations';
            document.getElementById('overlay-network').classList.remove('visible');
            document.getElementById('btn-locations').classList.add('active');
            document.getElementById('btn-faces').classList.remove('active');
            document.getElementById('view-subtitle').textContent = 'Geographic Scale of Corruption Across Los Angeles County';

            // Show map markers
            Object.values(mapMarkers).forEach(m => m.element.classList.remove('hidden'));
            updateMapConnections();
        }

        function showFaces() {
            currentView = 'faces';
            document.getElementById('overlay-network').classList.add('visible');
            document.getElementById('btn-faces').classList.add('active');
            document.getElementById('btn-locations').classList.remove('active');
            document.getElementById('view-subtitle').textContent = 'The Conspirators Behind the Scheme';

            // Hide map markers
            Object.values(mapMarkers).forEach(m => m.element.classList.add('hidden'));
            document.querySelectorAll('.mapboxgl-popup').forEach(p => p.remove());
            updateMapConnections();

            // Restart network simulation
            if (networkSimulation) networkSimulation.alpha(0.3).restart();
        }

        function flyToFraudFactory() {
            if (currentView === 'faces') showLocations();
            // Close any popups and cards
            document.querySelectorAll('.mapboxgl-popup').forEach(p => p.remove());
            closeLocationCard();
            // Fly back to hub view centered on courthouse
            map.flyTo({ center: COURTHOUSE_COORDS, zoom: 11.5, pitch: 55, bearing: 0, duration: 3000 });
        }

        // Navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');

        // Handle resize
        window.addEventListener('resize', () => {
            updateMapConnections();
            updateFaceHubPositions();
            const width = window.innerWidth;
            const height = window.innerHeight;
            networkSvg.attr("viewBox", [0, 0, width, height]);
            if (networkSimulation) {
                networkSimulation.force("center", d3.forceCenter(width / 2, height / 2));
                networkSimulation.alpha(0.3).restart();
            }
        });

        // ==================== LOCATION CARD PANEL ====================
        function showLocationCard(loc) {
            document.getElementById('card-title').textContent = loc.cardTitle || loc.name;
            document.getElementById('card-tagline').textContent = loc.cardTagline || loc.roleLabel;
            document.getElementById('card-image').src = loc.cardImage;

            document.getElementById('card-backdrop').classList.add('visible');
            document.getElementById('location-card').classList.add('visible');
        }

        function closeLocationCard() {
            document.getElementById('card-backdrop').classList.remove('visible');
            document.getElementById('location-card').classList.remove('visible');
        }

        // Close card on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLocationCard();
        });
    </script>
</body>
</html>
